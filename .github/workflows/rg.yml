name: Deploy Resource Group (subscription-level)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (dev/uat/prod)'
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod
        default: dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    env:
      BICEP: infra/rg/rg.bicep
      DEV_PARAMS: infra/rg/resource-group-dev.parameters.json
      UAT_PARAMS: infra/rg/resource-group-uat.parameters.json
      PROD_PARAMS: infra/rg/resource-group-prod.parameters.json

    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set subscription
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Pick parameter file
        id: pick
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then echo "PARAM=@${{ env.DEV_PARAMS }}" >> $GITHUB_OUTPUT; fi
          if [ "${{ github.event.inputs.environment }}" = "uat" ]; then echo "PARAM=@${{ env.UAT_PARAMS }}" >> $GITHUB_OUTPUT; fi
          if [ "${{ github.event.inputs.environment }}" = "prod" ]; then echo "PARAM=@${{ env.PROD_PARAMS }}" >> $GITHUB_OUTPUT; fi

      - name: Deploy resource group (subscription scope)
        run: |
          echo "Using parameters: ${{ steps.pick.outputs.PARAM }}"
          az deployment sub create \
            --name "rg-deploy-${{ github.run_id }}" \
            --location "$(jq -r '.parameters.location.value' ${${{ steps.pick.outputs.PARAM }#@}} 2>/dev/null || echo eastus)" \
            --template-file "${{ env.BICEP }}" \
            --parameters "${{ steps.pick.outputs.PARAM }}" \
            --only-show-errors
