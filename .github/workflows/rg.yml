name: Deploy Resource Group (subscription-level)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (dev/uat/prod)'
        required: true
        type: choice
        options:
          - dev
          - uat
          - prod
        default: dev
      location:
        description: 'Azure location (overrides param file if provided)'
        required: false
        default: ''

jobs:
  deploy-rg:
    runs-on: ubuntu-latest
    # Enforce GitHub Environment approvals
    environment: ${{ github.event.inputs.environment }}

    env:
      BICEP_FILE: infra/rg/rg.bicep
      PARAMS_DEV: infra/rg/resource-group-dev.parameters.json
      PARAMS_UAT: infra/rg/resource-group-uat.parameters.json
      PARAMS_PROD: infra/rg/resource-group-prod.parameters.json

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set subscription
        run: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Pick params file
        id: params
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [ "$ENV" = "dev" ]; then echo "PARAM_FILE=${{ env.PARAMS_DEV }}" >> $GITHUB_OUTPUT; fi
          if [ "$ENV" = "uat" ]; then echo "PARAM_FILE=${{ env.PARAMS_UAT }}" >> $GITHUB_OUTPUT; fi
          if [ "$ENV" = "prod" ]; then echo "PARAM_FILE=${{ env.PARAMS_PROD }}" >> $GITHUB_OUTPUT; fi
          echo "SELECTED_ENV=$ENV" >> $GITHUB_OUTPUT

      - name: What-if (preview)
        run: |
          LOCATION="${{ github.event.inputs.location }}"
          if [ -z "$LOCATION" ]; then
            PARAM_FILE_PATH="${{ steps.params.outputs.PARAM_FILE }}"; PARAM_FILE_PATH=${PARAM_FILE_PATH#@}
            LOCATION=$(jq -r '.parameters.location.value // empty' "$PARAM_FILE_PATH")
            if [ -z "$LOCATION" ]; then LOCATION="eastus"; fi
          fi

          az deployment sub what-if \
            --location "$LOCATION" \
            --template-file "${{ env.BICEP_FILE }}" \
            --parameters "${{ steps.override.outputs.USING_PARAM_FILE }}" \
            --query "properties.changeSummary" --output json

      - name: Deploy (subscription-level)
        run: |
          LOCATION="${{ github.event.inputs.location }}"
          if [ -z "$LOCATION" ]; then
            PARAM_FILE_PATH="${{ steps.params.outputs.PARAM_FILE }}"; PARAM_FILE_PATH=${PARAM_FILE_PATH#@}
            LOCATION=$(jq -r '.parameters.location.value // empty' "$PARAM_FILE_PATH")
            if [ -z "$LOCATION" ]; then LOCATION="eastus"; fi
          fi

          DEPLOY_NAME="rg-deploy-${{ github.run_id }}"

          az deployment sub create \
            --name "$DEPLOY_NAME" \
            --location "$LOCATION" \
            --template-file "${{ env.BICEP_FILE }}" \
            --parameters "${{ steps.override.outputs.USING_PARAM_FILE }}" \
            --only-show-errors
